# æµ‹è¯•è¯´æ˜

æœ¬ç›®å½•åŒ…å« ELA Extension çš„æµ‹è¯•æ–‡ä»¶ã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)
- [æµ‹è¯•ç»“æ„](#æµ‹è¯•ç»“æ„)
- [æµ‹è¯•è¦†ç›–](#æµ‹è¯•è¦†ç›–)
- [é›†æˆæµ‹è¯• API Key è®¾ç½®](#é›†æˆæµ‹è¯•-api-key-è®¾ç½®)
- [ç¼–å†™æ–°æµ‹è¯•](#ç¼–å†™æ–°æµ‹è¯•)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

å¦‚æœè¿˜æ²¡æœ‰å®‰è£…æµ‹è¯•ä¾èµ–ï¼Œè¯·å…ˆè¿è¡Œï¼š

```bash
npm install
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
npm test
```

## ğŸ§ª è¿è¡Œæµ‹è¯•

### åŸºæœ¬å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# ç›‘å¬æ¨¡å¼ï¼ˆæ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼‰
npm run test:watch

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
# åªè¿è¡Œ background.js çš„æµ‹è¯•
npm test -- background.test.js

# åªè¿è¡Œ content.js çš„æµ‹è¯•
npm test -- content.test.js

# åªè¿è¡Œ util.js çš„æµ‹è¯•
npm test -- util.test.js

# åªè¿è¡Œ storage.js çš„æµ‹è¯•
npm test -- storage.test.js

# åªè¿è¡Œ options.js çš„æµ‹è¯•
npm test -- options.test.js

# åªè¿è¡Œ api.js çš„æµ‹è¯•
npm test -- api.test.js

       # åªè¿è¡Œ sidepanel.js çš„æµ‹è¯•
       npm test -- sidepanel.test.js

       # åªè¿è¡Œ chataction.js çš„æµ‹è¯•
       npm test -- chataction.test.js

# æˆ–è€…ä½¿ç”¨ Jest çš„è·¯å¾„åŒ¹é…
npm test -- src/__tests__/background.test.js
npm test -- src/__tests__/content.test.js
npm test -- src/__tests__/storage.test.js
npm test -- src/__tests__/options.test.js
npm test -- src/__tests__/api.test.js
npm test -- src/__tests__/sidepanel.test.js
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹

```bash
# ä½¿ç”¨æµ‹è¯•åç§°åŒ¹é…
npm test -- -t "initStorageValue"

# è¿è¡Œç‰¹å®š describe å—
npm test -- -t "å­˜å‚¨ç®¡ç†å‡½æ•°"
```

### è°ƒè¯•æµ‹è¯•

```bash
# è¯¦ç»†è¾“å‡ºæ¨¡å¼
npm test -- --verbose

# åªæ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•
npm test -- --onlyFailures

# æ›´æ–°å¿«ç…§ï¼ˆå¦‚æœæœ‰ï¼‰
npm test -- -u
```

## ğŸ“ æµ‹è¯•ç»“æ„

### Background.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/background.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Background.js æµ‹è¯•
â”œâ”€â”€ å­˜å‚¨ç®¡ç†å‡½æ•°
â”‚   â”œâ”€â”€ initStorageValue (6ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ initStorageValues (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ UI æ›´æ–°å‡½æ•°
â”‚   â””â”€â”€ updateBadge (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ æ‰©å±•åˆå§‹åŒ–
â”‚   â””â”€â”€ initializeExtension (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
â””â”€â”€ äº‹ä»¶ç›‘å¬å™¨
    â”œâ”€â”€ chrome.runtime.onInstalled (2ä¸ªæµ‹è¯•)
    â”œâ”€â”€ chrome.action.onClicked (1ä¸ªæµ‹è¯•)
    â”œâ”€â”€ chrome.commands.onCommand (1ä¸ªæµ‹è¯•)
    â”œâ”€â”€ chrome.storage.local.onChanged (2ä¸ªæµ‹è¯•)
    â””â”€â”€ chrome.runtime.onMessage (3ä¸ªæµ‹è¯•)
```

### Content.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/content.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Content.js æµ‹è¯•
â”œâ”€â”€ çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ initializeState (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ updateState (1ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ æ–‡æœ¬é€‰æ‹©å¤„ç†
â”‚   â”œâ”€â”€ getSelectedText (5ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ sendSelectedText (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ handleTextSelection (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ äº‹ä»¶ç›‘å¬å™¨
â”‚   â””â”€â”€ handleMouseUp (2ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ åˆå§‹åŒ–
â”‚   â””â”€â”€ initialize (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â””â”€â”€ é›†æˆæµ‹è¯• (2ä¸ªæµ‹è¯•ç”¨ä¾‹)
```

### Util.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/util.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Util.js æµ‹è¯•
â”œâ”€â”€ å­—ç¬¦ä¸²å¤„ç†
â”‚   â””â”€â”€ maskMsg (9ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚       â”œâ”€â”€ æ©ç é•¿å­—ç¬¦ä¸²
â”‚       â”œâ”€â”€ å¤„ç†çŸ­å­—ç¬¦ä¸²
â”‚       â”œâ”€â”€ å¤„ç†ç©ºå€¼/null/undefined
â”‚       â”œâ”€â”€ å¤„ç†éå­—ç¬¦ä¸²ç±»å‹
â”‚       â””â”€â”€ è¾¹ç•Œæƒ…å†µ
â””â”€â”€ DOM æ“ä½œ
    â””â”€â”€ calculateLines (17ä¸ªæµ‹è¯•ç”¨ä¾‹)
        â”œâ”€â”€ è®¡ç®—å•è¡Œ/å¤šè¡Œæ–‡æœ¬
        â”œâ”€â”€ å‚æ•°éªŒè¯
        â”œâ”€â”€ é”™è¯¯å¤„ç†
        â”œâ”€â”€ DOM æ¸…ç†
        â””â”€â”€ æ ·å¼å¤åˆ¶
```

### Storage.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/storage.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Storage.js æµ‹è¯•
â”œâ”€â”€ åŸºæœ¬ CRUD æ“ä½œ
â”‚   â”œâ”€â”€ getStorageValue (6ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ setStorageValue (6ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ removeStorageValue (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ getStorageValues (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ åˆå§‹åŒ–å‡½æ•°
â”‚   â”œâ”€â”€ initStorageValue (8ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ initStorageValues (6ä¸ªæµ‹è¯•ç”¨ä¾‹)
â””â”€â”€ å­˜å‚¨ç›‘å¬å™¨
    â””â”€â”€ createStorageListener (8ä¸ªæµ‹è¯•ç”¨ä¾‹)
```

### Options.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/options.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Options.js æµ‹è¯•
â”œâ”€â”€ TTS é…ç½®ç®¡ç†
â”‚   â””â”€â”€ initTTSEndpoint (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ API Key ç®¡ç†
â”‚   â””â”€â”€ initAPIKey (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ TTS æ¨¡å‹å’Œè¯­éŸ³
â”‚   â”œâ”€â”€ initTTSModel (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ initTTSVoice (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ Chat é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ initChatEndpoint (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ initChatModel (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ Action Items ç®¡ç†
â”‚   â”œâ”€â”€ initActionItems (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ constructActionItemsHTML (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ è¾…åŠ©å‡½æ•°
â”‚   â”œâ”€â”€ createRadioOption (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ setHelpInfo (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ resetToDefaults (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â””â”€â”€ åˆå§‹åŒ–
    â””â”€â”€ initializeOptions (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
```

### Api.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/api.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Api.js æµ‹è¯•
â”œâ”€â”€ fetchAudio (6ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ æˆåŠŸè·å–éŸ³é¢‘æ•°æ®
â”‚   â”œâ”€â”€ å¤„ç†ç©ºæ¶ˆæ¯
â”‚   â”œâ”€â”€ å¤„ç†æœªé…ç½®çš„ endpoint æˆ– token
â”‚   â”œâ”€â”€ å¤„ç† HTTP é”™è¯¯å“åº”
â”‚   â”œâ”€â”€ å¤„ç† 401 é”™è¯¯å¹¶æ˜¾ç¤ºå‹å¥½æ¶ˆæ¯
â”‚   â””â”€â”€ å¤„ç†ç½‘ç»œé”™è¯¯
â”œâ”€â”€ fetchChat (7ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ æˆåŠŸè·å–æµå¼å“åº”
â”‚   â”œâ”€â”€ æˆåŠŸè·å–éæµå¼å“åº”
â”‚   â”œâ”€â”€ å¤„ç†ç©ºæ¶ˆæ¯
â”‚   â”œâ”€â”€ å¤„ç†æœªé…ç½®çš„ endpoint æˆ– token
â”‚   â”œâ”€â”€ å¤„ç† HTTP é”™è¯¯å“åº”
â”‚   â”œâ”€â”€ å¤„ç† 401 é”™è¯¯å¹¶æ˜¾ç¤ºå‹å¥½æ¶ˆæ¯
â”‚   â””â”€â”€ ä½¿ç”¨é»˜è®¤çš„ stream å‚æ•°
â”œâ”€â”€ streamResponseRead (7ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ è¯»å–æµå¼å“åº”æ•°æ®
â”‚   â”œâ”€â”€ å¤„ç† DONE æ ‡è®°
â”‚   â”œâ”€â”€ è·³è¿‡ç©ºè¡Œ
â”‚   â”œâ”€â”€ å¤„ç†æ— æ•ˆçš„ reader
â”‚   â”œâ”€â”€ å¤„ç† JSON è§£æé”™è¯¯
â”‚   â”œâ”€â”€ å¤„ç†è¯»å–é”™è¯¯
â”‚   â””â”€â”€ å¤„ç†æ²¡æœ‰ content çš„å“åº”
â””â”€â”€ é›†æˆæµ‹è¯•ï¼ˆé»˜è®¤è·³è¿‡ï¼‰
    â”œâ”€â”€ åº”è¯¥å®é™…è°ƒç”¨ TTS API
    â””â”€â”€ åº”è¯¥å®é™…è°ƒç”¨ Chat API
```

### Sidepanel.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/sidepanel.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Sidepanel.js æµ‹è¯•
â”œâ”€â”€ applyConfigData (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ æ­£ç¡®åº”ç”¨é…ç½®æ•°æ®
â”‚   â”œâ”€â”€ ä½¿ç”¨é»˜è®¤å€¼å½“é…ç½®æ•°æ®ä¸º null æˆ– undefined
â”‚   â”œâ”€â”€ å¤„ç†æ— æ•ˆçš„ action_items
â”‚   â””â”€â”€ å¤„ç†éæ•°ç»„çš„ action_items
â”œâ”€â”€ _showOnoff (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ æ›´æ–° toggleSwitch çš„ checked çŠ¶æ€
â”‚   â”œâ”€â”€ æ›´æ–° onoff å…ƒç´ çš„æ–‡æœ¬
â”‚   â””â”€â”€ å¤„ç† toggleSwitch ä¸å­˜åœ¨çš„æƒ…å†µ
â”œâ”€â”€ getBtnSetting (1ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â””â”€â”€ åˆ›å»ºè®¾ç½®æŒ‰é’®å…ƒç´ 
â”œâ”€â”€ createButton (2ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ åˆ›å»ºæŒ‰é’®å…ƒç´ 
â”‚   â””â”€â”€ åˆ›å»ºç¦ç”¨çš„æŒ‰é’®
â”œâ”€â”€ handleStorageChanges (5ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ å¤„ç† onoff å˜åŒ–
â”‚   â”œâ”€â”€ å¤„ç† TTS é…ç½®å˜åŒ–
â”‚   â”œâ”€â”€ å¤„ç† null/undefined å€¼ï¼Œä½¿ç”¨é»˜è®¤å€¼
â”‚   â”œâ”€â”€ å¤„ç† action_items å˜åŒ–
â”‚   â””â”€â”€ å¤„ç†æ— æ•ˆçš„ action_itemsï¼Œä½¿ç”¨é»˜è®¤å€¼
â”œâ”€â”€ setupStorageListeners (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ è®¾ç½®å­˜å‚¨ç›‘å¬å™¨
â”‚   â”œâ”€â”€ ç§»é™¤æ—§çš„ç›‘å¬å™¨å†æ·»åŠ æ–°çš„
â”‚   â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ
â”œâ”€â”€ initOnoffState (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ é€šè¿‡ init() åˆå§‹åŒ– onoff çŠ¶æ€
â”‚   â”œâ”€â”€ å¤„ç† toggleSwitch ä¸å­˜åœ¨çš„æƒ…å†µ
â”‚   â””â”€â”€ åœ¨å¼€å…³å˜åŒ–æ—¶æ›´æ–°å­˜å‚¨
â”œâ”€â”€ initConfig (2ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ è°ƒç”¨ getStorageValues å¹¶åº”ç”¨é…ç½®
â”‚   â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ
â”œâ”€â”€ initButtons (5ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ åˆå§‹åŒ–è®¾ç½®æŒ‰é’®
â”‚   â”œâ”€â”€ åˆå§‹åŒ–æ·»åŠ å†…å®¹å—æŒ‰é’®
â”‚   â”œâ”€â”€ åœ¨è®¾ç½®æŒ‰é’®ç‚¹å‡»æ—¶æ‰“å¼€é€‰é¡¹é¡µ
â”‚   â”œâ”€â”€ åœ¨æ·»åŠ æŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨ add_content_block
â”‚   â””â”€â”€ å¤„ç†æŒ‰é’®ä¸å­˜åœ¨çš„æƒ…å†µ
â”œâ”€â”€ setupMessageListeners (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨
â”‚   â”œâ”€â”€ å¤„ç† selectedText æ¶ˆæ¯
â”‚   â”œâ”€â”€ å¤„ç†å…¶ä»–ç±»å‹çš„æ¶ˆæ¯
â”‚   â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ
â””â”€â”€ init (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
    â”œâ”€â”€ å®Œæˆåˆå§‹åŒ–æµç¨‹
    â”œâ”€â”€ åœ¨ debug æ¨¡å¼ä¸‹æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    â””â”€â”€ å¤„ç†åˆå§‹åŒ–é”™è¯¯
```

### Chataction.js æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½äº `src/__tests__/chataction.test.js`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
Chataction.js æµ‹è¯•
â”œâ”€â”€ showBtn (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ æ˜¾ç¤ºæŒ‰é’®ï¼ˆè®¾ç½®ä¸º visibleï¼‰
â”‚   â”œâ”€â”€ éšè—æŒ‰é’®ï¼ˆè®¾ç½®ä¸º hiddenï¼‰
â”‚   â”œâ”€â”€ å¤„ç†æ— æ•ˆçš„æŒ‰é’®å…ƒç´ 
â”‚   â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ
â”œâ”€â”€ disableAllBtn (5ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ ç¦ç”¨æ‰€æœ‰æŒ‰é’®
â”‚   â”œâ”€â”€ å¯ç”¨æ‰€æœ‰æŒ‰é’®
â”‚   â”œâ”€â”€ å¤„ç†æ— æ•ˆçš„æŒ‰é’®æ•°ç»„
â”‚   â”œâ”€â”€ å¤„ç†æ²¡æœ‰ disabled å±æ€§çš„æŒ‰é’®
â”‚   â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ
â”œâ”€â”€ _createResponseElement (2ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ åˆ›å»ºå“åº”å…ƒç´ 
â”‚   â””â”€â”€ åˆ›å»ºåŒ…å« textarea çš„å“åº”å…ƒç´ 
â”œâ”€â”€ _createMenuButtons (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ åˆ›å»ºèœå•æŒ‰é’®å®¹å™¨
â”‚   â”œâ”€â”€ åˆ›å»ºæ¸…é™¤å’Œå¤åˆ¶æŒ‰é’®
â”‚   â”œâ”€â”€ åœ¨æ¸…é™¤æŒ‰é’®ç‚¹å‡»æ—¶æ¸…ç©ºæ–‡æœ¬
â”‚   â””â”€â”€ åœ¨å¤åˆ¶æŒ‰é’®ç‚¹å‡»æ—¶å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
â”œâ”€â”€ _createActionPannel (3ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”‚   â”œâ”€â”€ åˆ›å»ºæ“ä½œæŒ‰é’®é¢æ¿
â”‚   â”œâ”€â”€ ä¸ºæ¯ä¸ªæ¿€æ´»çš„æ“ä½œé¡¹åˆ›å»ºæŒ‰é’®
â”‚   â””â”€â”€ é™åˆ¶åˆ—æ•°åœ¨ 1-3 ä¹‹é—´
â””â”€â”€ createCustomPannel (4ä¸ªæµ‹è¯•ç”¨ä¾‹)
    â”œâ”€â”€ åˆ›å»ºè‡ªå®šä¹‰é¢æ¿
    â”œâ”€â”€ åœ¨æ²¡æœ‰æ¿€æ´»çš„æ“ä½œé¡¹æ—¶è¿”å›ç©º div
    â”œâ”€â”€ å¤„ç† current_action_items_active ä¸º null çš„æƒ…å†µ
    â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ
```

## ğŸ“Š æµ‹è¯•è¦†ç›–

### å½“å‰æµ‹è¯•è¦†ç›–

#### Background.js

- âœ… **å­˜å‚¨ç®¡ç†å‡½æ•°**ï¼š100% è¦†ç›–
  - `initStorageValue`ï¼šæ­£å¸¸æµç¨‹ã€é”™è¯¯å¤„ç†ã€è¾¹ç•Œæƒ…å†µ
  - `initStorageValues`ï¼šæ‰¹é‡æ“ä½œã€å¹¶è¡Œå¤„ç†ã€ç©ºé…ç½®

- âœ… **UI æ›´æ–°å‡½æ•°**ï¼š100% è¦†ç›–
  - `updateBadge`ï¼šON/OFF çŠ¶æ€ã€é”™è¯¯å¤„ç†ã€å¤šæ¬¡è°ƒç”¨

- âœ… **æ‰©å±•åˆå§‹åŒ–**ï¼š100% è¦†ç›–
  - `initializeExtension`ï¼šå®Œæ•´åˆå§‹åŒ–æµç¨‹ã€é”™è¯¯å¤„ç†ã€é…ç½®éªŒè¯

- âœ… **äº‹ä»¶ç›‘å¬å™¨**ï¼šæ³¨å†Œå’ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•

#### Content.js

- âœ… **çŠ¶æ€ç®¡ç†**ï¼š100% è¦†ç›–
  - `initializeState`ï¼šä»å­˜å‚¨åŠ è½½ã€é»˜è®¤å€¼å¤„ç†ã€é”™è¯¯å¤„ç†
  - `updateState`ï¼šçŠ¶æ€æ›´æ–°

- âœ… **æ–‡æœ¬é€‰æ‹©å¤„ç†**ï¼š100% è¦†ç›–
  - `getSelectedText`ï¼šè·å–é€‰ä¸­æ–‡æœ¬ã€è¾¹ç•Œæƒ…å†µã€é”™è¯¯å¤„ç†
  - `sendSelectedText`ï¼šå‘é€æ¶ˆæ¯ã€ç©ºæ–‡æœ¬å¤„ç†ã€æ¡†æ¶æ£€æµ‹
  - `handleTextSelection`ï¼šé€‰æ‹©å¤„ç†ã€æ‰©å±•çŠ¶æ€æ£€æŸ¥

- âœ… **äº‹ä»¶ç›‘å¬å™¨**ï¼š100% è¦†ç›–
  - `handleMouseUp`ï¼šé¼ æ ‡äº‹ä»¶å¤„ç†

- âœ… **åˆå§‹åŒ–**ï¼š100% è¦†ç›–
  - `initialize`ï¼šå®Œæ•´åˆå§‹åŒ–æµç¨‹ã€å­˜å‚¨ç›‘å¬ã€äº‹ä»¶æ³¨å†Œ

- âœ… **é›†æˆæµ‹è¯•**ï¼šå®Œæ•´æµç¨‹æµ‹è¯•

#### Util.js

- âœ… **å­—ç¬¦ä¸²å¤„ç†**ï¼š100% è¦†ç›–
  - `maskMsg`ï¼šæ©ç åŠŸèƒ½ã€è¾¹ç•Œæƒ…å†µã€é”™è¯¯å¤„ç†ã€éå­—ç¬¦ä¸²ç±»å‹

- âœ… **DOM æ“ä½œ**ï¼š100% è¦†ç›–
  - `calculateLines`ï¼šè¡Œæ•°è®¡ç®—ã€å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†ã€DOM æ¸…ç†ã€æ ·å¼å¤åˆ¶

#### Storage.js

- âœ… **åŸºæœ¬ CRUD æ“ä½œ**ï¼š100% è¦†ç›–
  - `getStorageValue`ï¼šæ­£å¸¸è·å–ã€é»˜è®¤å€¼å¤„ç†ã€é”™è¯¯å¤„ç†
  - `setStorageValue`ï¼šæ­£å¸¸è®¾ç½®ã€é”™è¯¯å¤„ç†ã€å‚æ•°éªŒè¯
  - `removeStorageValue`ï¼šæ­£å¸¸åˆ é™¤ã€é”™è¯¯å¤„ç†
  - `getStorageValues`ï¼šæ‰¹é‡è·å–ã€éƒ¨åˆ†é”®ä¸å­˜åœ¨çš„æƒ…å†µ

- âœ… **åˆå§‹åŒ–å‡½æ•°**ï¼š100% è¦†ç›–
  - `initStorageValue`ï¼šåˆå§‹åŒ–å•ä¸ªå€¼ã€é»˜è®¤å€¼å¤„ç†ã€é”™è¯¯å¤„ç†
  - `initStorageValues`ï¼šæ‰¹é‡åˆå§‹åŒ–ã€éƒ¨åˆ†å¤±è´¥å¤„ç†

- âœ… **å­˜å‚¨ç›‘å¬å™¨**ï¼š100% è¦†ç›–
  - `createStorageListener`ï¼šç›‘å¬å•ä¸ª/å¤šä¸ªé”®ã€å›è°ƒè§¦å‘ã€ç§»é™¤ç›‘å¬å™¨

#### Options.js

- âœ… **é…ç½®ç®¡ç†**ï¼š100% è¦†ç›–
  - TTS é…ç½®ï¼šendpointã€modelã€voice
  - Chat é…ç½®ï¼šendpointã€model
  - API Key ç®¡ç†
  - Action Items ç®¡ç†
  - è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºé€‰é¡¹ã€è®¾ç½®å¸®åŠ©ä¿¡æ¯ã€é‡ç½®é»˜è®¤å€¼
  - åˆå§‹åŒ–æµç¨‹

#### Api.js

- âœ… **API è°ƒç”¨**ï¼š100% è¦†ç›–
  - `fetchAudio`ï¼šæˆåŠŸã€é”™è¯¯å¤„ç†ã€401 é”™è¯¯ã€ç½‘ç»œé”™è¯¯
  - `fetchChat`ï¼šæµå¼/éæµå¼å“åº”ã€é”™è¯¯å¤„ç†ã€401 é”™è¯¯
  - `streamResponseRead`ï¼šæµå¼è¯»å–ã€DONE æ ‡è®°ã€é”™è¯¯å¤„ç†ã€JSON è§£æé”™è¯¯

- â­ï¸ **é›†æˆæµ‹è¯•**ï¼šé»˜è®¤è·³è¿‡ï¼ˆéœ€è¦çœŸå® API key å’Œç½‘ç»œè¿æ¥ï¼‰

#### Sidepanel.js

- âœ… **é…ç½®ç®¡ç†**ï¼š100% è¦†ç›–
  - `applyConfigData`ï¼šåº”ç”¨é…ç½®ã€é»˜è®¤å€¼å¤„ç†ã€action_items å¤„ç†
  - `handleStorageChanges`ï¼šå¤„ç†å„ç§å­˜å‚¨å˜åŒ–ã€é»˜è®¤å€¼å¤„ç†

- âœ… **UI å‡½æ•°**ï¼š100% è¦†ç›–
  - `_showOnoff`ï¼šæ›´æ–°å¼€å…³çŠ¶æ€å’Œæ–‡æœ¬
  - `getBtnSetting`ï¼šåˆ›å»ºè®¾ç½®æŒ‰é’®
  - `createButton`ï¼šåˆ›å»ºæŒ‰é’®å…ƒç´ 

- âœ… **åˆå§‹åŒ–**ï¼š100% è¦†ç›–
  - `initOnoffState`ï¼šåˆå§‹åŒ–å¼€å…³çŠ¶æ€ã€äº‹ä»¶ç›‘å¬
  - `initConfig`ï¼šåˆå§‹åŒ–é…ç½®ã€é”™è¯¯å¤„ç†
  - `initButtons`ï¼šåˆå§‹åŒ–æŒ‰é’®ã€äº‹ä»¶å¤„ç†
  - `init`ï¼šå®Œæ•´åˆå§‹åŒ–æµç¨‹

- âœ… **æ¶ˆæ¯å¤„ç†**ï¼š100% è¦†ç›–
  - `setupMessageListeners`ï¼šè®¾ç½®ç›‘å¬å™¨ã€å¤„ç† selectedText æ¶ˆæ¯ã€é”™è¯¯å¤„ç†

- âœ… **å­˜å‚¨ç›‘å¬å™¨**ï¼š100% è¦†ç›–
  - `setupStorageListeners`ï¼šè®¾ç½®ç›‘å¬å™¨ã€ç§»é™¤æ—§ç›‘å¬å™¨ã€é”™è¯¯å¤„ç†

#### Chataction.js

- âœ… **UI è¾…åŠ©å‡½æ•°**ï¼š100% è¦†ç›–
  - `showBtn`ï¼šæ˜¾ç¤º/éšè—æŒ‰é’®ã€é”™è¯¯å¤„ç†
  - `disableAllBtn`ï¼šå¯ç”¨/ç¦ç”¨æŒ‰é’®æ•°ç»„ã€é”™è¯¯å¤„ç†

- âœ… **é¢æ¿åˆ›å»º**ï¼š100% è¦†ç›–
  - `createCustomPannel`ï¼šåˆ›å»ºè‡ªå®šä¹‰é¢æ¿ã€å¤„ç†ç©ºæ“ä½œé¡¹ã€é”™è¯¯å¤„ç†
  - `_createResponseElement`ï¼šåˆ›å»ºå“åº”æ˜¾ç¤ºå…ƒç´ 
  - `_createActionPannel`ï¼šåˆ›å»ºæ“ä½œæŒ‰é’®é¢æ¿ã€åˆ—æ•°é™åˆ¶ã€æŒ‰é’®åˆ›å»º
  - `_createMenuButtons`ï¼šåˆ›å»ºèœå•æŒ‰é’®ï¼ˆæ¸…é™¤å’Œå¤åˆ¶ï¼‰ã€äº‹ä»¶å¤„ç†ã€å‰ªè´´æ¿æ“ä½œ

### æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š

```bash
npm run test:coverage
```

æŠ¥å‘Šä¼šç”Ÿæˆåœ¨ `coverage/` ç›®å½•ä¸‹ï¼Œæ‰“å¼€ `coverage/lcov-report/index.html` æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚

## âœï¸ ç¼–å†™æ–°æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶æ¨¡æ¿

```javascript
describe('åŠŸèƒ½æ¨¡å—åç§°', () => {
  beforeEach(() => {
    // é‡ç½®æ‰€æœ‰ mock
    jest.clearAllMocks();
    chrome.storage.local.get.mockClear();
    // ... å…¶ä»– mock é‡ç½®
  });

  describe('å‡½æ•°åç§°', () => {
    it('åº”è¯¥æè¿°æµ‹è¯•åœºæ™¯', async () => {
      // 1. å‡†å¤‡ (Arrange)
      const input = 'test';
      chrome.storage.local.get.mockResolvedValue({});

      // 2. æ‰§è¡Œ (Act)
      const result = await functionToTest(input);

      // 3. æ–­è¨€ (Assert)
      expect(result).toBe(expected);
    });
  });
});
```

### å¸¸ç”¨ Mock æ¨¡å¼

#### Mock Chrome Storage

```javascript
// Mock æˆåŠŸè·å–
chrome.storage.local.get.mockResolvedValue({ key: 'value' });

// Mock è·å–å¤±è´¥
chrome.storage.local.get.mockRejectedValue(new Error('Storage error'));

// Mock è®¾ç½®æˆåŠŸ
chrome.storage.local.set.mockResolvedValue({});
```

#### Mock Chrome Action

```javascript
// Mock è®¾ç½®å¾½ç« æˆåŠŸ
chrome.action.setBadgeText.mockResolvedValue({});

// Mock è®¾ç½®å¾½ç« å¤±è´¥
chrome.action.setBadgeText.mockRejectedValue(new Error('Badge error'));
```

#### Mock Console

```javascript
// åœ¨ beforeEach ä¸­è®¾ç½®
global.console.error = jest.fn();
global.console.log = jest.fn();

// åœ¨æµ‹è¯•ä¸­éªŒè¯
expect(console.error).toHaveBeenCalledWith('Error message');
```

### æµ‹è¯•æœ€ä½³å®è·µ

1. **AAA æ¨¡å¼**ï¼šArrangeï¼ˆå‡†å¤‡ï¼‰â†’ Actï¼ˆæ‰§è¡Œï¼‰â†’ Assertï¼ˆæ–­è¨€ï¼‰
2. **æè¿°æ¸…æ™°**ï¼šä½¿ç”¨ä¸­æ–‡æè¿°æµ‹è¯•åœºæ™¯ï¼Œè®©æµ‹è¯•å³æ–‡æ¡£
3. **ç‹¬ç«‹æµ‹è¯•**ï¼šæ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•
4. **æ¸…ç† Mock**ï¼šåœ¨ `beforeEach` ä¸­é‡ç½®æ‰€æœ‰ mock
5. **æµ‹è¯•è¾¹ç•Œ**ï¼šæµ‹è¯•æ­£å¸¸æµç¨‹ã€é”™è¯¯æƒ…å†µã€è¾¹ç•Œå€¼

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: æµ‹è¯•å¤±è´¥ï¼Œæç¤º Chrome API æœªå®šä¹‰ï¼Ÿ

**A:** ç¡®ä¿ `jest.setup.js` ä¸­æ­£ç¡®é…ç½®äº† Chrome API mockã€‚æ£€æŸ¥ `jest.config.js` ä¸­çš„ `setupFilesAfterEnv` é…ç½®ã€‚

### Q: å¦‚ä½•æµ‹è¯•å¼‚æ­¥å‡½æ•°ï¼Ÿ

**A:** ä½¿ç”¨ `async/await`ï¼š

```javascript
it('åº”è¯¥å¤„ç†å¼‚æ­¥æ“ä½œ', async () => {
  chrome.storage.local.get.mockResolvedValue({});
  const result = await asyncFunction();
  expect(result).toBe(expected);
});
```

### Q: å¦‚ä½•æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨ï¼Ÿ

**A:** ç”±äºäº‹ä»¶ç›‘å¬å™¨åœ¨ `background.js` ä¸­æ³¨å†Œï¼Œæˆ‘ä»¬ä¸»è¦æµ‹è¯•ï¼š
1. ç›‘å¬å™¨æ˜¯å¦æ³¨å†Œ
2. ç›‘å¬å™¨å›è°ƒå‡½æ•°çš„é€»è¾‘ï¼ˆæå–å‡ºæ¥å•ç‹¬æµ‹è¯•ï¼‰

### Q: æµ‹è¯•è¿è¡Œå¾ˆæ…¢ï¼Ÿ

**A:** 
- ä½¿ç”¨ `--maxWorkers=2` é™åˆ¶å¹¶è¡Œæ•°
- ä½¿ç”¨ `--runInBand` ä¸²è¡Œè¿è¡Œ
- ä½¿ç”¨ `--watch` æ¨¡å¼åªè¿è¡Œå˜åŒ–çš„æµ‹è¯•

### Q: å¦‚ä½•è°ƒè¯•å•ä¸ªæµ‹è¯•ï¼Ÿ

**A:** ä½¿ç”¨ `--testNamePattern` æˆ– `-t`ï¼š

```bash
npm test -- -t "åº”è¯¥ä½¿ç”¨é»˜è®¤å€¼"
```

æˆ–è€…åœ¨æµ‹è¯•ä¸­æ·»åŠ  `debugger;` è¯­å¥ï¼Œç„¶åä½¿ç”¨ Node.js è°ƒè¯•å™¨ã€‚

## ğŸ“ æµ‹è¯•å‘½ä»¤é€ŸæŸ¥

```bash
# åŸºæœ¬è¿è¡Œ
npm test                          # è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test:watch               # ç›‘å¬æ¨¡å¼
npm run test:coverage            # ç”Ÿæˆè¦†ç›–ç‡

# è¿‡æ»¤æµ‹è¯•
npm test -- background.test.js   # è¿è¡Œç‰¹å®šæ–‡ä»¶
npm test -- -t "initStorageValue" # è¿è¡ŒåŒ¹é…çš„æµ‹è¯•

# è°ƒè¯•é€‰é¡¹
npm test -- --verbose            # è¯¦ç»†è¾“å‡º
npm test -- --onlyFailures       # åªæ˜¾ç¤ºå¤±è´¥
npm test -- --bail               # é‡åˆ°å¤±è´¥ç«‹å³åœæ­¢
```

## ğŸ”‘ é›†æˆæµ‹è¯• API Key è®¾ç½®

`api.test.js` åŒ…å«é›†æˆæµ‹è¯•ï¼Œé»˜è®¤è·³è¿‡ã€‚è¦è¿è¡Œé›†æˆæµ‹è¯•ï¼Œéœ€è¦è®¾ç½® API keyã€‚

### æ–¹æ³• 1ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

#### åœ¨å‘½ä»¤è¡Œä¸­è®¾ç½®

```bash
# è¿è¡Œé›†æˆæµ‹è¯•
SKIP_INTEGRATION_TESTS=false TEST_API_KEY=your-actual-api-key npm test -- src/__tests__/api.test.js

# æˆ–è€…å¯¼å‡ºç¯å¢ƒå˜é‡
export SKIP_INTEGRATION_TESTS=false
export TEST_API_KEY=your-actual-api-key
npm test -- src/__tests__/api.test.js
```

#### åœ¨ package.json ä¸­æ·»åŠ æµ‹è¯•è„šæœ¬

åœ¨ `package.json` çš„ `scripts` éƒ¨åˆ†æ·»åŠ ï¼š

```json
{
  "scripts": {
    "test:integration": "SKIP_INTEGRATION_TESTS=false TEST_API_KEY=$TEST_API_KEY jest src/__tests__/api.test.js"
  }
}
```

ç„¶åè¿è¡Œï¼š
```bash
TEST_API_KEY=your-actual-api-key npm run test:integration
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ .env æ–‡ä»¶ï¼ˆéœ€è¦ dotenvï¼‰

#### å®‰è£… dotenv

```bash
npm install --save-dev dotenv
```

#### åˆ›å»º .env.test æ–‡ä»¶

```bash
# .env.test
SKIP_INTEGRATION_TESTS=false
TEST_API_KEY=your-actual-api-key
```

#### ä¿®æ”¹ jest.setup.js

åœ¨ `jest.setup.js` å¼€å¤´æ·»åŠ ï¼š

```javascript
require('dotenv').config({ path: '.env.test' });
```

### æ–¹æ³• 3ï¼šç›´æ¥åœ¨æµ‹è¯•ä»£ç ä¸­è®¾ç½®ï¼ˆä¸æ¨èï¼Œä½†æ–¹ä¾¿å¿«é€Ÿæµ‹è¯•ï¼‰

åœ¨ `api.test.js` çš„ `beforeAll` ä¸­ç›´æ¥è®¾ç½®ï¼š

```javascript
beforeAll(() => {
  if (SKIP_INTEGRATION) {
    return;
  }
  
  // ç›´æ¥åœ¨è¿™é‡Œè®¾ç½® API keyï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
  global.current_auth_token = 'your-actual-api-key-here';
});
```

### æ–¹æ³• 4ï¼šä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡

åœ¨ `~/.bashrc` æˆ– `~/.zshrc` ä¸­æ·»åŠ ï¼š

```bash
export TEST_API_KEY=your-actual-api-key
```

ç„¶åè¿è¡Œæµ‹è¯•ï¼š

```bash
SKIP_INTEGRATION_TESTS=false npm test -- src/__tests__/api.test.js
```

### æ³¨æ„äº‹é¡¹

1. **ä¸è¦æäº¤ API key åˆ°ç‰ˆæœ¬æ§åˆ¶**
   - ç¡®ä¿ `.env.test` åœ¨ `.gitignore` ä¸­
   - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  API key

2. **ä½¿ç”¨æµ‹è¯•ä¸“ç”¨çš„ API key**
   - å»ºè®®ä½¿ç”¨å•ç‹¬çš„æµ‹è¯• API keyï¼Œè€Œä¸æ˜¯ç”Ÿäº§ç¯å¢ƒçš„ key
   - è®¾ç½® API key çš„ä½¿ç”¨é™é¢

3. **é›†æˆæµ‹è¯•é»˜è®¤è·³è¿‡**
   - é›†æˆæµ‹è¯•ä½¿ç”¨ `describe.skip`ï¼Œé»˜è®¤ä¸ä¼šè¿è¡Œ
   - è¦è¿è¡Œé›†æˆæµ‹è¯•ï¼Œéœ€è¦ï¼š
     - è®¾ç½® `SKIP_INTEGRATION_TESTS=false`
     - è®¾ç½®æœ‰æ•ˆçš„ `TEST_API_KEY`

4. **Node.js ç‰ˆæœ¬è¦æ±‚**
   - Node.js 18+ å†…ç½®äº† `fetch`ï¼Œä¸éœ€è¦é¢å¤–å®‰è£…
   - Node.js < 18 éœ€è¦å®‰è£… `node-fetch`: `npm install node-fetch`

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
# æ–¹æ³• 1ï¼šå‘½ä»¤è¡Œè®¾ç½®
SKIP_INTEGRATION_TESTS=false TEST_API_KEY=your-key npm test -- src/__tests__/api.test.js

# æ–¹æ³• 2ï¼šå¦‚æœå·²è®¾ç½®ç¯å¢ƒå˜é‡
SKIP_INTEGRATION_TESTS=false npm test -- src/__tests__/api.test.js
```

## ğŸ¯ ä¸‹ä¸€æ­¥

- [x] æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆå·²å®Œæˆï¼Œé»˜è®¤è·³è¿‡ï¼‰
- [ ] æ·»åŠ  E2E æµ‹è¯•ï¼ˆä½¿ç”¨ Puppeteerï¼‰
- [ ] æé«˜ä»£ç è¦†ç›–ç‡åˆ° 90%+
- [ ] æ·»åŠ æ€§èƒ½æµ‹è¯•
- [ ] è®¾ç½® CI/CD è‡ªåŠ¨è¿è¡Œæµ‹è¯•

## ğŸ“š ç›¸å…³èµ„æº

- [Jest å®˜æ–¹æ–‡æ¡£](https://jestjs.io/docs/getting-started)
- [Chrome Extension API æ–‡æ¡£](https://developer.chrome.com/docs/extensions/reference/)
- [æµ‹è¯•æœ€ä½³å®è·µ](https://github.com/goldbergyoni/javascript-testing-best-practices)

---

**æœ€åæ›´æ–°**: 2025-01-13  
**æµ‹è¯•æ¡†æ¶**: Jest 29.7.0  
**æµ‹è¯•ç¯å¢ƒ**: Node.js

## ğŸ“¦ æµ‹è¯•æ–‡ä»¶åˆ—è¡¨

å½“å‰æµ‹è¯•æ–‡ä»¶ï¼š

- âœ… `background.test.js` - Background è„šæœ¬æµ‹è¯•
- âœ… `content.test.js` - Content è„šæœ¬æµ‹è¯•
- âœ… `util.test.js` - å·¥å…·å‡½æ•°æµ‹è¯•
- âœ… `storage.test.js` - å­˜å‚¨ç®¡ç†æ¨¡å—æµ‹è¯•
- âœ… `options.test.js` - é€‰é¡¹é¡µé¢æµ‹è¯•
- âœ… `api.test.js` - API è°ƒç”¨æµ‹è¯•
- âœ… `sidepanel.test.js` - ä¾§è¾¹æ ä¸»æ–‡ä»¶æµ‹è¯•
- ğŸ“ `mockConst.mock.js` - Mock å¸¸é‡æ–‡ä»¶ï¼ˆéæµ‹è¯•æ–‡ä»¶ï¼‰
